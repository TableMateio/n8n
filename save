#!/bin/bash
# Get computer name for commit message
COMPUTER_NAME=$(scutil --get ComputerName)

echo "🚀 N8N Save Script - Syncing Project & Database"
echo "=============================================="

# Check which database file exists and is larger
OUTER_DB=~/.n8n/database.sqlite
INNER_DB=~/.n8n/.n8n/database.sqlite
OUTER_SIZE=0
INNER_SIZE=0

if [ -f "$OUTER_DB" ]; then
  OUTER_SIZE=$(stat -f "%z" "$OUTER_DB")
fi

if [ -f "$INNER_DB" ]; then
  INNER_SIZE=$(stat -f "%z" "$INNER_DB")
fi

# Convert bytes to readable format (manual since numfmt isn't available on macOS)
format_bytes() {
    local bytes=$1
    if [ $bytes -gt 1073741824 ]; then
        echo "$(( bytes / 1073741824 )) GB"
    elif [ $bytes -gt 1048576 ]; then
        echo "$(( bytes / 1048576 )) MB"
    elif [ $bytes -gt 1024 ]; then
        echo "$(( bytes / 1024 )) KB"
    else
        echo "$bytes bytes"
    fi
}

echo "📊 Database Status:"
echo "   Outer database: $(format_bytes $OUTER_SIZE)"
echo "   Inner database: $(format_bytes $INNER_SIZE)"

if [ $INNER_SIZE -gt $OUTER_SIZE ]; then
  echo "✅ Using inner database (larger)"
  SOURCE_DB="$INNER_DB"
  SOURCE_CONFIG=~/.n8n/.n8n/config
else
  echo "✅ Using outer database (larger or only available)"
  SOURCE_DB="$OUTER_DB"
  SOURCE_CONFIG=~/.n8n/config
fi

# Copy database locally for backup (since Git can't handle it in forks)
echo ""
echo "💾 Creating local database backup..."
cp "$SOURCE_DB" "./database.sqlite.local"
if [ -d "$SOURCE_CONFIG" ]; then
    rsync -av "$SOURCE_CONFIG" ./config/
fi

echo ""
echo "🔄 Pushing code changes to Git..."
# Add all changes except large database files
git add .
git commit -m "Update from $COMPUTER_NAME at $(date)"
git push

echo ""
echo "✅ Save Complete!"
echo "   📁 Code & config: Pushed to Git"
echo "   💾 Database: Backed up locally (synced via Dropbox)"
echo "   🔗 Your laptop can access the database via Dropbox sync"
echo ""
echo "💡 Note: Database syncs automatically via Dropbox since this project"
echo "   is in your Dropbox folder. No separate action needed!"

